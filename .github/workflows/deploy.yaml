name: Deep Cloudflared Debug

on:
  push:
    branches: [ "main" ]

jobs:
  debug-cloudflared-connection:
    runs-on: ubuntu-latest

    steps:
    # Bước 1: Lấy code để workflow có thể chạy
    - name: Checkout code
      uses: actions/checkout@v4

    # Bước 2: Cài đặt Cloudflared
    - name: Install cloudflared
      run: |
        curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared.deb

    # Bước 3: Tạo file xác thực cloudflared
    - name: Create cloudflared certificate
      run: |
        mkdir -p ~/.cloudflared/
        echo "${{ secrets.CLOUDFLARE_CERT }}" > ~/.cloudflared/cert.pem
        
    # Bước 4: Kiểm tra file cert
    - name: Verify Certificate File
      run: |
        echo "--- Verifying cloudflared certificate file ---"
        ls -la ~/.cloudflared/
        head -n 2 ~/.cloudflared/cert.pem 
        
    # Bước 5: Chạy cloudflared với chế độ debug
    - name: Test cloudflared connection directly with debug logs
      run: |
        # Chạy lệnh cloudflared với loglevel debug để xem chi tiết quá trình handshake
        /usr/local/bin/cloudflared --loglevel debug access ssh --hostname ${{ secrets.K8S_HOST }}