name: Debug SSH Connection

on:
  push:
    branches: [ "main" ]

jobs:
  debug-ssh:
    runs-on: ubuntu-latest

    steps:
    # Bước 1: Lấy code để workflow có thể chạy
    - name: Checkout code
      uses: actions/checkout@v4

    # Bước 2: Cài đặt Cloudflared
    - name: Install cloudflared
      run: |
        curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared.deb

    # Bước 3: Tạo file xác thực cloudflared
    - name: Create cloudflared certificate
      run: |
        mkdir -p ~/.cloudflared/
        echo "${{ secrets.CLOUDFLARE_CERT }}" > ~/.cloudflared/cert.pem

    # Bước 4: Tạo file cấu hình SSH
    - name: Create SSH config
      run: |
        mkdir -p ~/.ssh
        echo "Host ${{ secrets.K8S_HOST }}" > ~/.ssh/config
        echo "  ProxyCommand /usr/local/bin/cloudflared access ssh --hostname %h" >> ~/.ssh/config

    # Bước 5: Kiểm tra các file đã được tạo đúng chưa
    - name: Verify Created Files
      run: |
        echo "--- Verifying cloudflared certificate file ---"
        ls -la ~/.cloudflared/
        # Kiểm tra xem file cert có nội dung không
        head -n 2 ~/.cloudflared/cert.pem 
        echo ""
        echo "--- Verifying SSH config file ---"
        cat ~/.ssh/config
        
    # Bước 6: Chạy SSH với chế độ hiển thị chi tiết (Verbose)
    - name: Test SSH Connection with Verbose Output
      # Action này chỉ dùng để load key và password vào môi trường
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.K8S_PRIVATE_KEY }}
    - run: ssh -v ${{ secrets.K8S_USER }}@${{ secrets.K8S_HOST }} "echo 'SSH Connection successful!'"